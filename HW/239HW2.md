<h1>Code Smell: Comments</h1>

 ความหมายของ Code Smell: Comments
-----------------------

Comments (คอมเมนต์ที่ใช้เพื่อ “อธิบายสิ่งที่โค้ดควรสื่อได้เอง”) ถือเป็น code smell เพราะเป็นสัญญาณว่าโค้ดอ่านยากหรือสื่อความหมายไม่ชัด จนต้องพึ่งคอมเมนต์มาช่วยอธิบาย “ตัวแปรคืออะไร” หรือ “โค้ดส่วนนี้ทำอะไร”

แนวคิดหลักของ smell นี้ (ตามแนว Refactoring) คือ:

<ul>
<li>คอมเมนต์จำนวนมากไม่ได้ “แก้ปัญหา” ที่แท้จริง แต่เป็นการ “ปิดทับปัญหา” ของโค้ดที่อ่านยาก </li>
<li>ถ้าโค้ดดีและตั้งชื่อชัด คอมเมนต์อธิบายการทำงานควรลดลง เพราะ โค้ดควรเป็นเอกสารของตัวเอง (self-documenting code) </li>
</ul>

ทำไม Comments ถึงเป็น smell ?
<ol>
  
<li> เพิ่มภาระให้ code : ต้องแก้ทั้งโค้ดและคอมเมนต์ให้ตรงกัน </li>

<li> ลดความน่าเชื่อถือของระบบ : คอมเมนต์ผิดทำให้ตัดสินใจผิด  </li>

<li> ซ่อนความซับซ้อนที่ควร refactor : แทนที่จะทำให้โค้ดชัดเจนกลับไปพึ่งคำอธิบาย </li>

</ol>


หมายเหตุ : “good comments” มักตอบคำถามว่า ทำไม (why) ไม่ใช่ ทำอะไร (what) เพราะ what ของโค้ดควรบอกได้เอง

---


ตัวอย่างโค้ดที่เกิด Code Smell (C#)
---

ตัวอย่าง (ภาษา C#) ที่มีคอมเมนต์เยอะเพื่อช่วยอธิบาย เพราะโค้ดอ่านยากและชื่อไม่ชัด:
```
using System;

class Program
{
    // Calculate final total
    static double Calc(double p, double d, double t)
    {
        // p is price
        // d is discount percent
        // t is tax percent

        double a = p - (p * d / 100.0); // apply discount
        double b = a + (a * t / 100.0); // add tax

        // if total is negative, make it zero
        if (b < 0) b = 0;

        return b; // final total
    }

    static void Main()
    {
        Console.WriteLine(Calc(1000, 10, 7));
    }
}

```

จุดที่เป็น Comments smell ในตัวอย่างนี้
<ul>
 <li> ชื่อตัวแปร p, d, t, a, b ไม่สื่อความหมาย -> ต้องพึ่งคอมเมนต์ช่วย </li>

 <li> ฟังก์ชัน Calc ทำหลายขั้นตอนในก้อนเดียว -> ต้องมีคอมเมนต์ “บอกขั้น” </li>

 <li> คอมเมนต์บางอันซ้ำกับโค้ด เช่น // final total ทั้งที่ return b ก็รู้อยู่แล้ว </li>

 <li> ถ้าเปลี่ยนลำดับการคำนวณ (เช่นคิดภาษีก่อนลด) คอมเมนต์มีโอกาส “ผิด” ทันที </li>
 
</ul>

---


ตัวอย่างโค้ดที่ refactoring แล้ว (C#)
---

แนวคิด refactor เพื่อ “ลดคอมเมนต์” โดยทำให้โค้ดอธิบายตัวเอง:
<ul>
<li> Rename Method และ Variables ให้สื่อความหมาย </li>
<li> Extract Method แยกเป็นฟังก์ชันย่อยที่ชื่อชัด </li>
<li> ใช้ Math.Max(0, value) แทนคอมเมนต์ “ถ้าติดลบให้เป็นศูนย์” </li>
</ul>


```
using System;

public static class PriceCalculator
{
    public static double CalculateFinalTotal(double price, double discountPercent, double taxPercent)
    {
        double discountedPrice = ApplyPercentageDiscount(price, discountPercent);
        double totalWithTax = ApplyPercentageTax(discountedPrice, taxPercent);

        return Math.Max(0, totalWithTax);
    }

    private static double ApplyPercentageDiscount(double amount, double percent)
    {
        return amount - (amount * percent / 100.0);
    }

    private static double ApplyPercentageTax(double amount, double percent)
    {
        return amount + (amount * percent / 100.0);
    }
}

class Program
{
    static void Main()
    {
        Console.WriteLine(PriceCalculator.CalculateFinalTotal(1000, 10, 7));
    }
}

```

แนวคิด refactor เพื่อ “ลดคอมเมนต์” โดยทำให้โค้ดอธิบายตัวเอง:
<ul>
<li> เปลี่ยน Calc → CalculateFinalTotal ชัดเจนขึ้น </li>
<li> เปลี่ยน p,d,t,a,b → price, discountPercent, taxPercent, discountedPrice, totalWithTax </li>
<li> แยกขั้นตอนเป็นเมธอดย่อย: ApplyPercentageDiscount, ApplyPercentageTax </li>
<li> คอมเมนต์ที่เคยต้องใช้หายไป เพราะ “ชื่อ” ทำหน้าที่อธิบายแทน </li>
</ul>

ผลลัพธ์:
<ul>
<li> อ่านง่ายขึ้น ลด cognitive load </li>
<li> ลดความเสี่ยงคอมเมนต์ล้าสมัย </li>
<li> ทดสอบง่ายขึ้น </li>
</ul>

----

กรณีที่ Comments ไม่ได้แปลว่าโค้ดมีปัญหาเสมอ (ไม่จำเป็นต้อง refactor)
---

แม้ Comments จะเป็น smell ในกรณีที่คอมเมนต์ทำหน้าที่แทน “ชื่อที่ดี/โครงสร้างที่ดี”
แต่มีหลายกรณีที่คอมเมนต์ จำเป็น และถือว่า “ดี” ได้ เช่น


1) คอมเมนต์ที่อธิบาย “ทำไม (Why)” ไม่ใช่ “ทำอะไร (What)” : โค้ดบอก what ได้อยู่แล้ว แต่เหตุผลเชิงธุรกิจ
```
// Workaround: Payment gateway may send duplicate callbacks on network timeout.
// Ignore same transactionId within 30 seconds to prevent double charge.
```

2) คอมเมนต์เตือนความเสี่ยงสูง / ด้านความปลอดภัย / ผลกระทบระบบ
```
// WARNING: Changing token hashing invalidates all existing sessions.

```

3) TODO & FIXME ที่เป็นแผนงานชัดเจน (และทีมมีวินัยจัดการ)
```
// TODO: Replace with streaming parser when file size can exceed 200MB.

```

4) Documentation comment สำหรับ public API (เป็น “สัญญา” ให้ผู้ใช้เมธอด) ใน C# มักใช้ XML documentation เพื่อสร้างเอกสาร
```
/// <summary>
/// Calculates the final price after applying discount and tax.
/// </summary>
/// <param name="price">Base price before discount and tax.</param>
/// <param name="discountPercent">Discount percentage (0-100).</param>
/// <param name="taxPercent">Tax percentage (0-100).</param>
/// <returns>Final total, never less than 0.</returns>
public static double CalculateFinalTotal(double price, double discountPercent, double taxPercent) { ... }
```
สรุปเกณฑ์ตัดสินใจ:
<ul>
<li> ถ้าคอมเมนต์มีไว้เพราะโค้ดชื่อไม่ชัด -> ควร refactor </li>
<li> ถ้าคอมเมนต์มีไว้บอกเหตุผล ข้อจำกัด ความเสี่ยง หรือเป็นเอกสาร API -> ควรเก็บไว้ </li>
</ul>

---

แหล่งอ้างอิง (References)
---

<ol>
  
<li> Martin Fowler : Refactoring: Improving the Design of Existing Code ( Comments smell และ refactor เพื่อลดการพึ่งคอมเมนต์) </li>
  <ul>
    Link : https://martinfowler.com/books/refactoring.html
  </ul>
<li> Refactoring Guru : “Code Smells: Comments” และแนวทาง refactoring (Rename, Extract Method )  </li>
  <ul>
    Link : https://refactoring.guru/smells/comments
  </ul>
<li> Microsoft Learn : “XML documentation comments (C#)” (อธิบายว่าคอมเมนต์แบบเอกสาร API มีเป้าหมายชัดและมีประโยชน์) </li>
  <ul>
    Link : https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/xmldoc/
  </ul>
</ol>

---

<img width="631" height="357" alt="image" src="https://github.com/user-attachments/assets/ebe1d417-5d8d-44c2-b3a7-8424967c1588" />


